name: Conformity Template Scanner

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.yaml'
      - '**.yml'
      - '**.json'
      - '.github/workflows/conformity-scan.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.yaml'
      - '**.yml'
      - '**.json'
  workflow_dispatch:

jobs:
  scan-template:
    name: Scan CloudFormation Template
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Run Conformity Scanner
        env:
          CONFORMITY_API_KEY: ${{ secrets.CONFORMITY_API_KEY }}
          CONFORMITY_REGION: ${{ secrets.CONFORMITY_REGION }}
          DEFAULT_REGION: us-west-2
        run: |
          export CONFORMITY_REGION="${CONFORMITY_REGION:-$DEFAULT_REGION}"
          python scan.py template.yaml
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: conformity-scan-results
          path: scan-results.json
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let results;
            try {
              results = JSON.parse(fs.readFileSync('scan-results.json', 'utf8'));
            } catch (e) {
              console.log('Could not read scan results');
              return;
            }
            
            const data = results.data || [];
            const failures = data.filter(item => item.attributes.status === 'FAILURE');
            const success = data.filter(item => item.attributes.status === 'SUCCESS');
            
            let comment = '## ðŸ” Conformity Scan Results\n\n';
            comment += `- âœ… Passed: ${success.length}\n`;
            comment += `- âŒ Failed: ${failures.length}\n\n`;
            
            if (failures.length > 0) {
              comment += '### Issues Found:\n\n';
              failures.forEach((failure, index) => {
                const attrs = failure.attributes;
                comment += `${index + 1}. **${attrs['rule-title'] || 'Unknown'}**\n`;
                comment += `   - Risk: ${attrs['risk-level'] || 'Unknown'}\n`;
                comment += `   - Resource: ${attrs.resource || 'N/A'}\n`;
                comment += `   - Message: ${attrs.message || 'No message'}\n\n`;
              });
            } else {
              comment += 'âœ… No security or compliance issues found!\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
